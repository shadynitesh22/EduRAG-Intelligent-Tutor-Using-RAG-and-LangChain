{% extends 'base.html' %}
{% load static %}

{% block title %}EduRAG - AI Tutor Chat{% endblock %}

{% block content %}
<!-- Upload Section (always visible) -->
<div class="upload-section mb-lg">
    <h3>Upload Study Material</h3>
    <form id="uploadForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="upload-form-row">
            <div class="input-group">
                <label class="form-label">File</label>
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="contentFile" name="file" accept=".txt,.pdf,.docx" class="file-upload-input" required>
                    <div class="file-upload-icon">üìÅ</div>
                    <div class="file-upload-text">Click to upload or drag and drop</div>
                    <div class="file-upload-hint">Supports: PDF, DOCX, TXT (Max: 200MB)</div>
                </div>
                <div id="fileValidation" class="file-validation" style="display: none;"></div>
            </div>
            <div class="input-group">
                <label class="form-label">Title</label>
                <input type="text" id="contentTitle" name="title" class="form-control" placeholder="Enter textbook title" required>
            </div>
        </div>
        <div class="upload-form-row">
            <div class="input-group">
                <label class="form-label">Subject</label>
                <select id="uploadSubject" name="subject_id" class="form-control" required>
                    <option value="">Select Subject</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <label class="form-label">Grade</label>
                <select id="uploadGrade" name="grade_id" class="form-control" required>
                    <option value="">Select Grade</option>
                    {% for grade in grades %}
                    <option value="{{ grade.id }}">Grade {{ grade.level }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="input-group mb-md">
            <button type="submit" class="btn btn-primary btn-small">Upload Content</button>
            <button type="button" class="btn btn-secondary btn-small" onclick="openManageModal()">Manage Subjects & Grades</button>
        </div>
    </form>
    <div id="uploadStatus"></div>
</div>

<!-- Uploaded Materials Section (always visible) -->
<div class="uploaded-materials-section mb-lg">
    <h3>Your Uploaded Materials</h3>
    <div id="uploadedMaterialsList" class="materials-container">
        <!-- This will be populated by JavaScript -->
        <div class="empty-state">
            <div class="empty-state-icon">üìö</div>
            <div class="empty-state-text">No materials uploaded yet</div>
            <div class="empty-state-hint">Upload your first study material to get started</div>
        </div>
    </div>
</div>

<!-- Main Chat Layout (always visible) -->
<div class="chat-layout">
    <!-- Chat Section -->
    <div class="chat-section">
        <div class="chat-header">
            <h2>AI Tutor Chat</h2>
            <div class="audit-mode-toggle">
                <label class="switch">
                    <input type="checkbox" id="auditModeToggle">
                    <span class="slider round"></span>
                </label>
                <span>Audit Mode</span>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages" style="overflow-y:auto;max-height:350px;">
            <div class="message system">
                <strong>Welcome to EduRAG!</strong><br>
                Upload your study material above, then ask me anything about your studies. I can help with various subjects and adapt my teaching style to your needs.
                <div class="audit-info" id="auditInfo" style="display: none;">
                    <br><strong>üîç Audit Mode Active:</strong> All interactions are being logged for analysis and improvement.
                </div>
            </div>
        </div>
        <div id="uploadPrompt" class="message system" style="display:none;"></div>
        <div class="loading" id="loading" style="display: none;"></div>
        <div class="chat-input-section">
            <div class="chat-input-group">
                <textarea id="questionInput" class="form-control" placeholder="Ask your question here..." rows="4"></textarea>
                <button class="btn btn-primary btn-large" id="askBtn" onclick="askQuestion()">Ask Question</button>
            </div>
            <div class="chat-filters">
                <select id="textbookFilter" class="form-control">
                    <option value="">All Textbooks</option>
                    <!-- This will be populated by JavaScript -->
                </select>
                <button type="button" class="btn btn-secondary btn-small" onclick="refreshTextbookDropdown()" style="margin-left: 10px;">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Controls Panel -->
        <div class="sidebar-section controls-panel">
            <div class="sidebar-section-header">
                <h3>üéõÔ∏è Controls</h3>
            </div>
            <div class="sidebar-section-content">
                <h4>Tutor Persona</h4>
                <div class="persona-selector">
                    <div class="persona-btn active" data-persona="helpful_tutor">Helpful</div>
                    <div class="persona-btn" data-persona="socratic_tutor">Socratic</div>
                    <div class="persona-btn" data-persona="encouraging_tutor">Encouraging</div>
                    <div class="persona-btn" data-persona="strict_tutor">Strict</div>
                </div>
                
                <h4>System Status</h4>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-indicator status-online"></span>
                        <span>Backend</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator status-online"></span>
                        <span>AI Model</span>
                    </div>
                    <div class="status-item">
                        <span class="status-indicator status-online"></span>
                        <span>Vector DB</span>
                    </div>
                </div>
                
                <button class="btn btn-secondary btn-small sidebar-btn" onclick="clearChat()">Clear Chat</button>
                <button class="btn btn-secondary btn-small sidebar-btn" onclick="exportChat()">Export Chat</button>
                <button class="btn btn-secondary btn-small sidebar-btn" onclick="openChatHistoryModal()">Chat History</button>
            </div>
        </div>

        <!-- Session Stats -->
        <div class="sidebar-section session-stats">
            <div class="sidebar-section-header">
                <h3>üìä Session Stats</h3>
            </div>
            <div class="sidebar-section-content">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="questionsAsked">0</div>
                        <div class="metric-label">Questions</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgResponseTime">0ms</div>
                        <div class="metric-label">Avg Response</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgRating">0.0</div>
                        <div class="metric-label">Avg Rating</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="sourcesUsed">0</div>
                        <div class="metric-label">Sources Used</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent History -->
        <!-- <div class="sidebar-section history-panel">
            <div class="sidebar-section-header">
                <h3>üïí Recent History</h3>
            </div>
            <div class="sidebar-section-content">
                <div id="historyList">
                    {% for question in recent_questions %}
                    <div class="history-item" data-question="{{ question.query_text }}" 
                         data-persona="{{ question.persona_used }}" 
                         data-subject="{{ question.subject_filter }}"
                         data-grade="{{ question.grade_filter }}">
                        <div class="history-item-question">{{ question.query_text|truncatechars:50 }}</div>
                        <div class="history-item-meta">
                            {{ question.get_persona_used_display|default:"Helpful" }} | 
                            {{ question.created_at|time }}
                        </div>
                        {% if question.rating %}
                        <div class="history-item-rating">
                            Rating: {{ question.rating }}/5
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="history-item empty">No previous questions</div>
                    {% endfor %}
                </div>
            </div>
        </div> -->
    </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rate This Response</h3>
            <button class="modal-close" onclick="closeFeedbackModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="rating-section">
                <label>How helpful was this response?</label>
                <div class="rating-stars">
                    <span class="star" data-rating="1">‚≠ê</span>
                    <span class="star" data-rating="2">‚≠ê</span>
                    <span class="star" data-rating="3">‚≠ê</span>
                    <span class="star" data-rating="4">‚≠ê</span>
                    <span class="star" data-rating="5">‚≠ê</span>
                </div>
                <div id="ratingLabel">Select a rating</div>
            </div>
            <div class="feedback-section">
                <label for="feedbackComment">Additional Comments (Optional)</label>
                <textarea id="feedbackComment" class="form-control" rows="3" placeholder="Share your thoughts about this response..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Manage Subjects & Grades Modal -->
<div id="manageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Manage Subjects & Grades</h3>
            <button class="modal-close" onclick="closeManageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="manage-section">
                <h4>Add New Subject</h4>
                <div class="input-group">
                    <input type="text" id="newSubjectName" class="form-control" placeholder="Enter subject name">
                    <button class="btn btn-primary" onclick="addSubject()">Add Subject</button>
                </div>
            </div>
            <div class="manage-section">
                <h4>Add New Grade</h4>
                <div class="input-group">
                    <input type="number" id="newGradeLevel" class="form-control" placeholder="Enter grade level (1-12)" min="1" max="12">
                    <button class="btn btn-primary" onclick="addGrade()">Add Grade</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat History Modal -->
<div id="chatHistoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chat History</h3>
            <button class="modal-close" onclick="closeChatHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="history-filters">
                <select id="historyDateFilter" class="form-control">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            <div id="chatHistoryContent">
                <!-- History content will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="exportChatHistory()">Export History</button>
            <button class="btn btn-secondary" onclick="closeChatHistoryModal()">Close</button>
        </div>
    </div>
</div>

<script>
// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing EduRAG page...');
    
    // Load uploaded materials on page load
    loadUploadedMaterials();
    
    // Load session stats
    loadSessionStats();
    
    console.log('‚úÖ Page initialization complete');
});

// Load uploaded materials from API
async function loadUploadedMaterials() {
    try {
        const response = await fetch('/api/textbooks/');
        const data = await response.json();
        
        const materials = data.results || data;
        displayUploadedMaterials(materials);
        
        // Start polling for processing materials
        startProcessingPolling();
        
        console.log('üìö Loaded materials:', materials.length);
    } catch (error) {
        console.error('‚ùå Error loading materials:', error);
        displayUploadedMaterials([]);
    }
}

// Display materials in the list
function displayUploadedMaterials(materials) {
    const container = document.getElementById('uploadedMaterialsList');
    if (!container) return;
    
    if (materials.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <div class="empty-state-text">No materials uploaded yet</div>
                <div class="empty-state-hint">Upload your first study material to get started</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    materials.forEach(material => {
        const statusClass = getStatusClass(material.processing_status);
        const statusIcon = getStatusIcon(material.processing_status);
        const fileIcon = getFileIcon(material.file);
        
        html += `
            <div class="material-item" data-id="${material.id}" data-status="${material.processing_status}">
                <div class="material-info">
                    <div class="material-icon">${fileIcon}</div>
                    <div class="material-details">
                        <div class="material-title">${material.title}</div>
                        <div class="material-meta">
                            <span>${material.subject.name}</span>
                            <span>Grade ${material.grade.level}</span>
                            <span>${formatDate(material.uploaded_at)}</span>
                        </div>
                    </div>
                </div>
                <div class="material-status">
                    <span class="status-badge ${statusClass}">
                        ${statusIcon} ${material.processing_status}
                    </span>
                </div>
                <div class="material-actions">
                    <button class="material-action-btn" onclick="viewMaterial('${material.id}')">View</button>
                    <button class="material-action-btn delete" onclick="deleteMaterial('${material.id}')">Delete</button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Utility functions
function getStatusClass(status) {
    switch (status) {
        case 'pending': return 'pending';
        case 'processing': return 'processing';
        case 'completed': return 'completed';
        case 'failed': return 'failed';
        default: return 'pending';
    }
}

function getStatusIcon(status) {
    switch (status) {
        case 'pending': return '‚è≥';
        case 'processing': return 'üîÑ';
        case 'completed': return '‚úÖ';
        case 'failed': return '‚ùå';
        default: return '‚è≥';
    }
}

function getFileIcon(filename) {
    const extension = filename.split('.').pop().toLowerCase();
    switch (extension) {
        case 'pdf': return 'üìÑ';
        case 'docx': return 'üìù';
        case 'txt': return 'üìÑ';
        default: return 'üìÅ';
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Start polling for processing materials
function startProcessingPolling() {
    const processingMaterials = document.querySelectorAll('[data-status="processing"], [data-status="pending"]');
    processingMaterials.forEach(material => {
        const materialId = material.getAttribute('data-id');
        if (materialId) {
            pollMaterialStatus(materialId);
        }
    });
}

// Poll material status until processing is complete
async function pollMaterialStatus(materialId) {
    const maxAttempts = 60; // 5 minutes with 5-second intervals
    let attempts = 0;
    
    const pollInterval = setInterval(async () => {
        attempts++;
        
        try {
            const response = await fetch(`/api/textbooks/${materialId}/`);
            if (response.ok) {
                const material = await response.json();
                
                // Update the material item in the list
                updateMaterialStatus(materialId, material.processing_status);
                
                // If processing is complete or failed, stop polling
                if (material.processing_status === 'completed' || material.processing_status === 'failed') {
                    clearInterval(pollInterval);
                    
                    if (material.processing_status === 'completed') {
                        showAlert(`Processing completed for: ${material.title}`, 'success');
                    } else if (material.processing_status === 'failed') {
                        showAlert(`Processing failed for: ${material.title}`, 'error');
                    }
                }
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
        
        // Stop polling after max attempts
        if (attempts >= maxAttempts) {
            clearInterval(pollInterval);
            console.log('Polling timeout for material:', materialId);
        }
    }, 5000); // Poll every 5 seconds
}

// Update material status in the UI
function updateMaterialStatus(materialId, status) {
    const materialItem = document.querySelector(`[data-id="${materialId}"]`);
    if (materialItem) {
        const statusBadge = materialItem.querySelector('.status-badge');
        if (statusBadge) {
            const statusClass = getStatusClass(status);
            const statusIcon = getStatusIcon(status);
            
            statusBadge.className = `status-badge ${statusClass}`;
            statusBadge.innerHTML = `${statusIcon} ${status}`;
        }
        
        // Update data attribute
        materialItem.setAttribute('data-status', status);
    }
}

// Material actions
function viewMaterial(materialId) {
    showAlert(`Viewing material with ID: ${materialId}`, 'info');
}

function deleteMaterial(materialId) {
    if (confirm('Are you sure you want to delete this material? This action cannot be undone.')) {
        fetch(`/api/textbooks/${materialId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('Material deleted successfully!', 'success');
                loadUploadedMaterials(); // Reload the list
            } else {
                showAlert('Failed to delete material.', 'error');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showAlert('Failed to delete material.', 'error');
        });
    }
}

// Load session stats
async function loadSessionStats() {
    try {
        const response = await fetch('/api/session-stats/');
        const stats = await response.json();
        
        // Update stats display
        const questionsAsked = document.getElementById('questionsAsked');
        const avgResponseTime = document.getElementById('avgResponseTime');
        const avgRating = document.getElementById('avgRating');
        const sourcesUsed = document.getElementById('sourcesUsed');
        
        if (questionsAsked) questionsAsked.textContent = stats.total_questions || 0;
        if (avgResponseTime) avgResponseTime.textContent = `${Math.round(stats.avg_response_time || 0)}ms`;
        if (avgRating) avgRating.textContent = (stats.avg_rating || 0).toFixed(1);
        if (sourcesUsed) sourcesUsed.textContent = stats.total_sources || 0;
        
        console.log('üìä Session stats loaded');
    } catch (error) {
        console.error('‚ùå Load session stats error:', error);
    }
}

// Show alert function
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="alert-close">&times;</button>
    `;
    
    // Insert at the top of the page
    document.body.insertBefore(alertDiv, document.body.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Modal functions
function openManageModal() {
    const modal = document.getElementById('manageModal');
    if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
    }
}

function closeManageModal() {
    const modal = document.getElementById('manageModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
    }
}

function openChatHistoryModal() {
    const modal = document.getElementById('chatHistoryModal');
    if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        loadChatHistory();
    }
}

function closeChatHistoryModal() {
    const modal = document.getElementById('chatHistoryModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
    }
}

// Add subject and grade functions
async function addSubject() {
    const nameInput = document.getElementById('newSubjectName');
    const name = nameInput.value.trim();
    
    if (!name) {
        showAlert('Please enter a subject name.', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/subjects/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ name: name })
        });
        
        if (response.ok) {
            showAlert('Subject added successfully!', 'success');
            nameInput.value = '';
            location.reload();
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to add subject.', 'error');
        }
    } catch (error) {
        console.error('Add subject error:', error);
        showAlert('Failed to add subject. Please try again.', 'error');
    }
}

async function addGrade() {
    const levelInput = document.getElementById('newGradeLevel');
    const level = parseInt(levelInput.value);
    
    if (!level || level < 1 || level > 12) {
        showAlert('Please enter a valid grade level (1-12).', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/grades/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ level: level })
        });
        
        if (response.ok) {
            showAlert('Grade added successfully!', 'success');
            levelInput.value = '';
            location.reload();
        } else {
            const result = await response.json();
            showAlert(result.error || 'Failed to add grade.', 'error');
        }
    } catch (error) {
        console.error('Add grade error:', error);
        showAlert('Failed to add grade. Please try again.', 'error');
    }
}

// Load chat history
async function loadChatHistory() {
    const historyContent = document.getElementById('chatHistoryContent');
    if (!historyContent) return;
    
    try {
        const response = await fetch('/api/feedback/');
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            const historyHtml = data.results.slice(0, 10).map(item => `
                <div class="chat-history-item">
                    <div class="chat-history-question">${item.query_text}</div>
                    <div class="chat-history-answer">${item.response_text}</div>
                    <div class="chat-history-meta">
                        <span class="chat-history-time">${new Date(item.created_at).toLocaleString()}</span>
                        ${item.rating ? `<span class="chat-history-rating">Rating: ${item.rating}/5</span>` : ''}
                        ${item.response_time_ms ? `<span class="chat-history-response-time">${item.response_time_ms}ms</span>` : ''}
                    </div>
                </div>
            `).join('');
            historyContent.innerHTML = historyHtml;
        } else {
            historyContent.innerHTML = '<div class="empty-state">No chat history found.</div>';
        }
    } catch (error) {
        console.error('‚ùå Load chat history error:', error);
        historyContent.innerHTML = '<div class="error">Failed to load chat history.</div>';
    }
}

function exportChatHistory() {
    const dateFilter = document.getElementById('historyDateFilter').value;
    
    fetch(`/api/feedback/export/?date_filter=${dateFilter}`)
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('‚ùå Export chat history error:', error);
        alert('Failed to export chat history.');
    });
}

console.log('‚úÖ Critical functions loaded and ready!');

// CRITICAL: Define all functions immediately in template
window.askQuestion = function() {
    console.log('‚ùì Asking question...');
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value.trim();
    
    if (!question) {
        showAlert('Please enter a question.', 'error');
        return;
    }

    // Get selected textbook
    const textbookFilter = document.getElementById('textbookFilter');
    const selectedTextbookId = textbookFilter ? textbookFilter.value : '';
    
    console.log('Question:', question);
    console.log('Selected textbook ID:', selectedTextbookId);
    
    // Show loading
    showLoading('AI is thinking...');
    
    // Add user message to chat
    addMessage('user', question);
    
    // Clear input
    questionInput.value = '';
    
    fetch('/api/ask/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            question: question,
            type: 'rag',
            persona: 'helpful_tutor',
            textbook_id: selectedTextbookId || ''
        })
    })
    .then(response => response.json())
    .then(result => {
        hideLoading();
        
        if (result.answer) {
            console.log('‚úÖ Question answered successfully');
            console.log('üìù Full AI response:', result.answer);
            console.log('üìù Response length:', result.answer.length);
            // Add AI response to chat
            addMessage('ai', result.answer, result.sources, result.response_time_ms);
            
            // Show feedback modal after a short delay
            setTimeout(() => {
                if (typeof showFeedbackModal === 'function') {
                    showFeedbackModal(result.query_log_id);
                }
            }, 1000);
            
            // Update session stats after successful response
            setTimeout(() => {
                updateSessionStats();
            }, 500);
            
        } else {
            console.error('‚ùå Question failed:', result.error);
            addMessage('error', `Error: ${result.error || 'Failed to get response'}`);
        }
    })
    .catch(error => {
        hideLoading();
        console.error('‚ùå Question error:', error);
        addMessage('error', 'Network error. Please try again.');
    });
};

window.refreshTextbookDropdown = async function() {
    console.log('üîÑ Refreshing textbook dropdown...');
    const dropdown = document.getElementById('textbookFilter');
    if (!dropdown) {
        console.error('‚ùå Dropdown not found: textbookFilter');
        return;
    }
    try {
        const response = await fetch('/api/textbooks/');
        const data = await response.json();
        console.log('üìö Dropdown API response:', data);
        
        const textbooks = data.results || data;
        console.log('üìö Textbooks for dropdown:', textbooks);
        
        dropdown.innerHTML = '<option value="">All Textbooks</option>';
        textbooks.forEach(book => {
            const status = book.processing_status;
            const statusIcon = getStatusIcon(status);
            const option = document.createElement('option');
            option.value = book.id;
            option.textContent = `${book.title} (${book.subject.name}, Grade ${book.grade.level}) ${statusIcon} [${status}]`;
            dropdown.appendChild(option);
        });
        console.log('üìö Textbook dropdown refreshed with', textbooks.length, 'books');
    } catch (error) {
        console.error('‚ùå Refresh dropdown error:', error);
    }
};

window.addMessage = function(type, content, sources = null, responseTime = null) {
    console.log(`üìù Adding ${type} message, content length:`, content ? content.length : 0);
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    let messageContent = '';
    
    if (type === 'user') {
        messageContent = `
            <div class="message-content">
                <strong>You:</strong> ${escapeHtml(content)}
            </div>
        `;
    } else if (type === 'ai') {
        console.log('üìù Formatting AI response, original length:', content.length);
        const formattedContent = formatAIResponse(content);
        console.log('üìù Formatted content length:', formattedContent.length);
        
        messageContent = `
            <div class="message-content">
                <strong>AI Tutor:</strong> ${formattedContent}
            </div>
        `;
        
        if (sources && sources.length > 0) {
            messageContent += `
                <div class="message-sources">
                    <strong>Sources:</strong>
                    <ul>
                        ${sources.map(source => `
                            <li>${source.textbook_title} (${source.subject}, Grade ${source.grade}) - Relevance: ${(source.similarity_score * 100).toFixed(1)}%</li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
        
        if (responseTime) {
            messageContent += `
                <div class="message-meta">
                    <small>Response time: ${responseTime}ms</small>
                </div>
            `;
        }
    } else if (type === 'error') {
        messageContent = `
            <div class="message-content error">
                <strong>Error:</strong> ${escapeHtml(content)}
            </div>
        `;
    }
    
    console.log('üìù Final message content length:', messageContent.length);
    messageDiv.innerHTML = messageContent;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    console.log('üìù Message added to chat');
};

window.formatAIResponse = function(text) {
    return text
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
};

window.escapeHtml = function(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
};

window.getStatusIcon = function(status) {
    switch (status) {
        case 'pending': return '‚è≥';
        case 'processing': return 'üîÑ';
        case 'completed': return '‚úÖ';
        case 'failed': return '‚ùå';
        default: return '‚è≥';
    }
};

window.clearChat = function() {
    console.log('üóëÔ∏è Clearing chat...');
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.innerHTML = `
            <div class="message system">
                <strong>Welcome to EduRAG!</strong><br>
                Upload your study material above, then ask me anything about your studies. I can help with various subjects and adapt my teaching style to your needs.
            </div>
        `;
    }
};

window.exportChat = function() {
    console.log('üì§ Exporting chat...');
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        const content = chatMessages.innerText;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_export_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }
};

window.showFeedbackModal = function(queryLogId) {
    console.log('üìù Opening feedback modal for query:', queryLogId);
    const modal = document.getElementById('feedbackModal');
    if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        
        // Reset rating
        document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
        const labelElement = document.getElementById('ratingLabel');
        if (labelElement) labelElement.textContent = 'Select a rating';
        
        // Clear comment
        const commentElement = document.getElementById('feedbackComment');
        if (commentElement) commentElement.value = '';
        
        // Store the query log ID
        modal.dataset.queryLogId = queryLogId;
    }
};

window.closeFeedbackModal = function() {
    console.log('üìù Closing feedback modal');
    const modal = document.getElementById('feedbackModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.dataset.queryLogId = '';
    }
};

window.submitFeedback = function() {
    console.log('üìù Submitting feedback...');
    
    const modal = document.getElementById('feedbackModal');
    const queryLogId = modal ? modal.dataset.queryLogId : null;
    
    if (!queryLogId) {
        showAlert('No active query to rate.', 'error');
        return;
    }
    
    const activeStar = document.querySelector('.star.active');
    if (!activeStar) {
        showAlert('Please select a rating.', 'error');
        return;
    }
    
    const rating = parseInt(activeStar.dataset.rating);
    const comment = document.getElementById('feedbackComment').value.trim();
    
    fetch('/api/feedback/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            query_log_id: queryLogId,
            rating: rating,
            feedback_text: comment
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Thank you for your feedback!', 'success');
            closeFeedbackModal();
            // Update session stats after feedback
            setTimeout(() => {
                updateSessionStats();
            }, 500);
        } else {
            showAlert(result.error || 'Failed to submit feedback.', 'error');
        }
    })
    .catch(error => {
        console.error('‚ùå Submit feedback error:', error);
        showAlert('Failed to submit feedback.', 'error');
    });
};

window.updateSessionStats = async function() {
    console.log('üìä Updating session stats...');
    try {
        const response = await fetch('/api/session-stats/');
        const stats = await response.json();
        
        console.log('üìä Session stats received:', stats);
        
        // Update stats display
        const questionsAsked = document.getElementById('questionsAsked');
        const avgResponseTime = document.getElementById('avgResponseTime');
        const avgRating = document.getElementById('avgRating');
        const sourcesUsed = document.getElementById('sourcesUsed');
        
        if (questionsAsked) questionsAsked.textContent = stats.total_questions || 0;
        if (avgResponseTime) avgResponseTime.textContent = `${Math.round(stats.avg_response_time || 0)}ms`;
        if (avgRating) avgRating.textContent = (stats.avg_rating || 0).toFixed(1);
        if (sourcesUsed) sourcesUsed.textContent = stats.total_sources || 0;
        
        console.log('üìä Session stats updated successfully');
    } catch (error) {
        console.error('‚ùå Update session stats error:', error);
    }
};

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Rating stars event listeners
    document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            
            // Update star display
            document.querySelectorAll('.star').forEach(s => s.classList.remove('active'));
            for (let i = 1; i <= rating; i++) {
                const starElement = document.querySelector(`[data-rating="${i}"]`);
                if (starElement) starElement.classList.add('active');
            }
            
            // Update label
            const labels = ['Select a rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            const labelElement = document.getElementById('ratingLabel');
            if (labelElement) labelElement.textContent = labels[rating];
        });
    });
    
    // History filter change listener
    const historyDateFilter = document.getElementById('historyDateFilter');
    if (historyDateFilter) {
        historyDateFilter.addEventListener('change', loadChatHistory);
    }
    
    // Modal close on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
                this.classList.remove('show');
            }
        });
    });
    
    // CRITICAL: Refresh dropdown on page load
    setTimeout(() => {
        refreshTextbookDropdown();
    }, 500);
    
    // Load initial session stats
    setTimeout(() => {
        updateSessionStats();
    }, 1000);
    
    console.log('‚úÖ Event listeners initialized!');
});
</script>
{% endblock %}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            